# **词法元素**

本节用于说明Larva代码的各词法元素的规则

对于编译器来说，输入的源代码文件可看做是一个字符序列，第一步工作就是做词法分析，将文件内容分割为一个个“词”（后简称“token”），
本节说明的词法元素是指Larva的各类词法

## **词法分析规则**

1. **忽略间隔空白**

    词法元素之间的空白（制表符、空格、换行）将被忽略，即间隔的空白符不参与实际词法和语法，在词法分析过程中会被忽略，
    例如以下代码在词法上都是合法的：

    ```
    int i=1;
    int j      =         i +3;
    int
    k
    =
    -
    (
    i
    +
    j
    )
    ; //int k = -(i + j);拆成每行一个token
    ```

    *Note*：和大部分语言一样，Larva推荐用适当空格、空行分隔的方式来提高代码可读性

    *Note*：注意这里说的是“词法元素之间的间隔空白”，块注释和原始字符串等跨行的词法元素本身可以包含空白符的，并不会被忽略，
    但编译器也会考虑到代码的可读性，对原始字符串中的某些空白做适当警告，具体见字符串字面量小节

1. **最长子串原则**

    * **原则**

        Larva的词法分析遵循最长子串原则，即在分析一个token的时候，如果可能有多种选择，会从当前位置开始选择最长的一个合法选择，例如：

        ```
        //      //单行注释开始符是一个整体，不会被解析为两个除号
        /**/    //同上，块注释开始符不会被解析为除号和乘号
        ++a;    //对a做++自增，而不是两个+号
        123abc  //由于整数字面量允许后缀（见相关小节），这里不会被解析为123和abc两个词
        1.f();  //看上去是对“1”做方法调用，但由于浮点数支持省略尾数0，因此第一个词是“1.”
        a.123   //被解析为“a”和“.123”，因为浮点数可以省略前导0

        //这里的例子只是作为最长子串原则的示例，其实大部分也都是语法错误
        ```

    * **特例**

        在有的语法设计下，最长子串原则可能会和人的习惯相悖，在Larva的泛型语法中存在一个特例：由于泛型类型实例化的语法是用尖括号“<>”，
        如果存在多层嵌套的话，右侧的“>>”按照最长子串原则将被解析为右移运算符，编译器在这里做了特殊处理，如果发现是嵌套的泛型类型实例，
        则将其视为两个“>”，由于泛型参数只可能是类型，不存在运算，因此不会出现歧义，例如：
        ```
        Iter<Iter<int>> it; //这里的“>>”被视为两个独立的“>”
        ```
        当然也可以将复杂的泛型实例分层写，提高可读性：
        ```
        Iter<
            Iter<int>
        > it;
        ```

## **注释**

Larva的注释分两种形式，除了注释说明外没有其他实质性的功能，但词法分析阶段只是简单将其丢弃掉

* **单行注释**

    单行注释以`//`开头，到所在行末尾，示例：

    ```
    int a = 0;  //这是一个单行注释
    int[] b = new int[]{
        1,  //插在跨行代码中的单行注释
        2,  //注释
    };
    ```

* **块注释**

    块注释以`/*`开头，`*/`结尾，可以跨行，例如：

    ```
    int a/*a的作用是……*/ = 123;
    /*
    b的作用是……
    */
    int b = 456;
    ```

* *Note*

    注释的解析是先分析开始标记，然后以当前行结束或向前找到结束标记，
    编译器不关心注释内容，因此块注释不能嵌套，只是简单扫描文件内容，找到结束标记`*/`

    字符串字面量的值是引号中的所有字符，不能直接在中间写注释，例如：

    ```
    String a = "hello /*这不是注释，是字符串的一部分*/world";
    String b = `hello //同上
    world`;
    ```

    这一点在Native代码的token中也是一样的

## **关键字**

Larva关键字（也叫保留字）用于在代码中描述对应的语法，不可将其用作标识符

关键字列表：

```
from    import
class   interface
public  usemethod   final   ref
void    bool        schar   char    short       ushort  int     uint    long    ulong   float   double
foreach for         while   break   continue    if      else    return  defer
nil     true        false   this
var
new     cast
_
```

具体每个关键字的用法参考相关语法章节

*Note*：单下划线“\_”是一个关键字，这个会用在一些变量和值的特殊处理中，例如用于忽略某个值的输出等，这在Golang或Python等语言中也是一个惯例，
所不同的是在这些语言中“\_”在词法上是一个普通的标识符，而在语法上做了特殊处理，如Golang不允许将其作为值直接使用，Larva则采用更直接的方式，
将其作为关键字，杜绝了用其当变量的可能

*Note*：关键字的设计思路是尽量与现有语言接近，如果是多单词组合，则采用小写连写不加下划线分隔的方式，从风格上和变量名等做区别，
如“usemethod”、“foreach”等

## **标识符**

标识符用于类名、接口名、变量名、函数名、模块名等可自定义的名字，规则：

1. 格式：`[A-Za-z_][A-Za-z_0-9]*`，意即字母或下划线开头，由字母数字下划线组成
1. 不能和关键字相同
1. 长度无限制
1. 大小写敏感，例如`time`和`Time`是不同的名字
1. 普通标识符不能为内建宏的形式，即不能同时以双下划线开头和结尾，内建宏的说明见下
1. 不强制要求标识符命名规范和风格

*Note*：Larva的标识符风格建议（和Python较接近）：

* 类、接口名采用大写字母开头的驼峰形式，如“String”、“Callable”等
* `final`修饰的全局变量（初始化后不可修改，也可叫做常量）用下划线连接全大写词的形式，如“BUF_SIZE”等
* 变量、函数名采用下划线连接全小写词的snake形式，如“recved_len”、“make_pair”等
* 模块名风格基本和变量和函数名风格相同，但标准库的第一级模块例外（因为强制要求不能有下划线，见“2.2.程序结构”中关于模块组织的限制说明）
* 如果一个名字是用于比较“私有”的功能或非正式功能，可用单下划线开头

### **内建宏**

内建宏是指同时以双下划线作为开头和结尾的特殊标识符，这些宏会在词法分析阶段由编译器做替换，
主要功能是能将一些编译环境、代码上下文的信息直接插入代码中

目前支持的内建宏有：

|内建宏              |类型   |说明                                                                                  |
|--------------------|-------|--------------------------------------------------------------------------------------|
|\_\_PLATFORM\_\_    |String |编译环境的平台全名，例如“Linux-2.6.32-754.el6.x86_64-x86_64-with-centos-6.10-Final”   |
|\_\_MACHINE\_\_     |String |编译环境的机器硬件名，例如“x86_64”                                                    |
|\_\_SYSTEM\_\_      |String |编译环境的系统名，例如“Linux”                                                         |
|\_\_MODULE\_\_      |String |当前模块名，例如“os/path”                                                             |
|\_\_FILE\_\_        |String |当前源代码文件名，一般为绝对路径形式                                                  |
|\_\_LINE\_\_        |int    |当前行在文件中的行号（从1开始）                                                       |
|\_\_TIMESTAMP\_\_   |long   |执行编译的Unix时间戳，精确到毫秒                                                      |

如果代码中出现了不能识别的内建宏，则编译报错

## **符号**

Larva中的符号主要起到分隔、运算和标记等作用

### **普通符号**

普通符号在词法分析的时候，都作为一个独立的token，主要起到分隔符和运算符的功能

Larva的普通符号列表：

```
.   ..
(   )   [   ]   {   }   :   ;   ,
~   !   +   -   *   /   %   &   |   ^   <<  >>
<   >   !=  ==  !== === <=  >=  &&  ||
=   +=  -=  *=  /=  %=  &=  |=  ^=  <<= >>= ++  --
```

各符号在不同语法中可能有不同的含义，在具体的语法说明中会提到，这里只是从词法元素的角度将其罗列出来

### **标记符号**

## **字面量**

## **特殊词法**

### **Native代码**

### **编译控制命令**

